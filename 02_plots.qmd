```{r setup}
#| message: false
#| include: false
library(tidyverse)
library(DT)
library(sf)
library(terra)
```

# Plots

All site and plot data needed for the analyses. The raw information needed would be number of individual per hectare, per site, per census/year, per plot, per species, and per cohort/diameter class with maybe an information on the plot area to later weigh the information

## Paracou

```{r parprep}
#| eval: false
paracou <- list.files("data/harmonized_datasets_ss", 
                      full.names = TRUE, pattern = "paracou") %>% 
  lapply(read_csv, 
         col_types = cols(TreeFieldNum = col_character(),
                          IdTree = col_character(),
                          TreeFieldNumOriginal = col_character(),
                          Site = col_character()
                          )) %>% 
  bind_rows() %>% 
  filter(LifeStatus) %>% 
  select(Site, Year, Plot, PlotArea, Family, Genus, Species, Diameter) %>% 
  mutate(diameter_class = ifelse(Diameter < 30, 10, 30)) %>% 
  mutate(diameter_class = ifelse(Diameter < 80, diameter_class, 80)) %>% 
  group_by(Site, Year, Plot, PlotArea, Family, Genus, Species, diameter_class) %>% 
  summarise(abundance = n()/unique(PlotArea),
            ba = sum((Diameter/2)^2*pi)/10^4/unique(PlotArea)) %>%
  ungroup() %>% 
  rename_all(tolower) %>% 
  rename(area = plotarea) %>% 
  mutate(genus = gsub("Indet.", "", genus)) %>% 
  mutate(species = gsub("Indet.", "undet", species)) %>% 
  mutate(treatment = ifelse(plot %in% c(1,6,11,13:15), "control", "logged")) %>% 
  mutate(rel_year = year - 1986) %>% 
  filter(paste(plot, year) != "15 2010")
delta_ba <- paracou %>% 
  group_by(plot, rel_year) %>% 
  summarise(ba = sum(ba)) %>% 
  filter(rel_year < 6) %>% 
  group_by(plot, post = as.numeric(rel_year > 0)) %>% 
  summarise(ba_mean = mean(ba), ba_min = min(ba)) %>% 
  gather(metric, value, -plot, -post) %>% 
  mutate(metric = paste0(metric, "_", post)) %>% 
  select(-post) %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  mutate(delta_ba = ba_mean_0 - ba_min_1) %>% 
  mutate(delta_ba = ifelse(delta_ba < 1, 0, delta_ba)) %>% 
  mutate(delta_ba_pct = delta_ba/ba_mean_0*100) %>% 
  rename(ba_pre = ba_mean_0, ba_post = ba_min_1) %>% 
  select(plot, ba_pre, ba_post, delta_ba, delta_ba_pct)
paracou <- paracou %>% 
  left_join(delta_ba) %>% 
  mutate_at(c("delta_ba", "delta_ba_pct"), ~ ifelse(is.na(.), 0, .))
write_tsv(paracou, "outputs/paracou.tsv")
```

```{r parissue}
#| message: false
#| warning: false
#| fig-cap: "Caption."
list.files("data/harmonized_datasets_ss", 
                      full.names = TRUE, pattern = "paracou") %>% 
  lapply(read_csv, 
         col_types = cols(TreeFieldNum = col_character(),
                          IdTree = col_character(),
                          TreeFieldNumOriginal = col_character(),
                          Site = col_character()
                          )) %>% 
  bind_rows() %>% 
  filter(Plot == 15, Year == 2010) %>% 
  ggplot(aes(XTreeUTM, YTreeUTM)) +
  geom_point() +
  theme_bw() +
  coord_fixed() +
  ggtitle("Paracou Plot 15", "2010")
```

```{r parre1}
#| message: false
#| warning: false
#| fig-cap: "Caption."
list.files("data/harmonized_datasets_ss", 
                      full.names = TRUE, pattern = "paracou") %>% 
  lapply(read_csv, 
         col_types = cols(TreeFieldNum = col_character(),
                          IdTree = col_character(),
                          TreeFieldNumOriginal = col_character(),
                          Site = col_character()
                          )) %>% 
  bind_rows() %>% 
  filter(Plot == 15) %>% 
  filter(LifeStatus) %>% 
  group_by(Year, Plot, PlotArea, Subplot, SubplotArea) %>% 
  summarise(abundance = n(),
            ba = sum((Diameter/2)^2*pi)/10^4) %>% 
  gather(variable, subplot_value, -Year, 
         -Plot, -PlotArea, -Subplot, -SubplotArea) %>% 
  group_by(Year, Plot, PlotArea, variable) %>% 
  mutate(plot_value = sum(subplot_value), 
         SubplotArea = unique(SubplotArea)) %>% 
  ungroup() %>% 
  mutate(plot_value = plot_value/PlotArea,
         subplot_value = subplot_value/SubplotArea) %>% 
  mutate(plot_value = ifelse(Year == 2010, NA, plot_value)) %>% 
  ggplot(aes(plot_value, subplot_value, col = Year)) +
  geom_point() +
  theme_bw() +
  geom_abline() +
  scale_color_viridis_c() +
  ggpubr::stat_cor() +
  ggpubr::stat_regline_equation(label.y.npc = 0.8) +
  facet_wrap(~ variable, scales = "free") +
  ggtitle("Paracou Plot 15")
```

```{r parre2}
#| message: false
#| warning: false
#| fig-cap: "Caption."
list.files("data/harmonized_datasets_ss", 
                      full.names = TRUE, pattern = "paracou") %>% 
  lapply(read_csv, 
         col_types = cols(TreeFieldNum = col_character(),
                          IdTree = col_character(),
                          TreeFieldNumOriginal = col_character(),
                          Site = col_character()
                          )) %>% 
  bind_rows() %>% 
  filter(Plot == 15) %>% 
  filter(LifeStatus) %>% 
  group_by(Year, Plot, PlotArea, Subplot, SubplotArea) %>% 
  summarise(abundance = n(),
            ba = sum((Diameter/2)^2*pi)/10^4) %>% 
   gather(variable, subplot_value, -Year, 
         -Plot, -PlotArea, -Subplot, -SubplotArea) %>% 
  group_by(Year, Plot, PlotArea, variable) %>% 
  mutate(plot_value = sum(subplot_value), 
         SubplotArea = unique(SubplotArea)) %>% 
 ungroup() %>% 
  mutate(plot_value = plot_value/PlotArea,
         subplot_value = subplot_value/SubplotArea) %>% 
  mutate(plot_value = ifelse(Year == 2010, NA, plot_value)) %>% 
  filter(Subplot != 1) %>%
  group_by(Year, Plot, PlotArea, variable, plot_value) %>% 
  summarise(three_subplot_mean_value = mean(subplot_value)) %>% 
  ggplot(aes(plot_value, three_subplot_mean_value, col = Year)) +
  theme_bw() +
  geom_abline() +
  geom_smooth(method = "lm", se = FALSE, col = "lightgrey") +
  geom_point() +
  scale_color_viridis_c() +
  ggpubr::stat_cor() +
  ggpubr::stat_regline_equation(label.y.npc = 0.8) +
  facet_wrap(~ variable, scales = "free") +
  ggtitle("Paracou Plot 15")
```

```{r parplot}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_tsv("outputs/paracou.tsv") %>% 
  group_by(site, year, rel_year, treatment, delta_ba, plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = plot)) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Basal area of tree " >=10 ~"cm dbh ["~m^{2}~ha^{-~1}~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))
```

## Missiones

```{r missionesprep}
#| eval: false
missiones <- read_csv("data/harmonized_datasets_ss/output_MISIONES.csv") %>% 
  filter(LifeStatus) %>% 
  filter(!(Family %in% c("muerto", "ND"))) %>% 
  select(Site, Year, Plot, PlotArea, Family, ScientificName, Diameter) %>% 
  mutate(Family = gsub("No determinado", "undet", Family)) %>% 
  mutate(ScientificName = gsub("No Determinado", "undet undet", ScientificName)) %>% 
  separate(ScientificName, c("Genus", "Species")) %>% 
  mutate(Species = ifelse(is.na(Species), "undet", Species)) %>%  
  mutate(Year = ifelse(Year == 2018, 2019, Year)) %>% 
  mutate(diameter_class = ifelse(Diameter < 30, 10, 30)) %>% 
  mutate(diameter_class = ifelse(Diameter < 80, diameter_class, 80)) %>% 
  filter(!is.na(diameter_class)) %>% 
  group_by(Site, Year, Plot, PlotArea, Family, Genus, Species, diameter_class) %>% 
  summarise(abundance = n()/unique(PlotArea),
            ba = sum((Diameter/2)^2*pi)/10^4/unique(PlotArea)) %>%
  rename_all(tolower) %>% 
  rename(area = plotarea) %>% 
  mutate(rel_year = year - 1999)
delta_ba <- missiones %>% 
  group_by(plot, rel_year) %>% 
  summarise(ba = sum(ba)) %>% 
  filter(rel_year < 6) %>% 
  group_by(plot, post = as.numeric(rel_year > 0)) %>% 
  summarise(ba_mean = mean(ba), ba_min = min(ba)) %>% 
  gather(metric, value, -plot, -post) %>% 
  mutate(metric = paste0(metric, "_", post)) %>% 
  select(-post) %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  mutate(delta_ba = ba_mean_0 - ba_min_1) %>% 
  mutate(delta_ba = ifelse(delta_ba < 1, 0, delta_ba)) %>% 
  mutate(delta_ba_pct = delta_ba/ba_mean_0*100) %>% 
  rename(ba_pre = ba_mean_0, ba_post = ba_min_1) %>% 
  select(plot, ba_pre, ba_post, delta_ba, delta_ba_pct)
missiones <- missiones %>% 
  left_join(delta_ba) %>% 
  mutate_at(c("delta_ba", "delta_ba_pct"), ~ ifelse(is.na(.), 0, .))
write_tsv(missiones, "outputs/missiones.tsv")
```

```{r mississue}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_csv("data/harmonized_datasets_ss/output_MISIONES.csv") %>% 
  filter(Plot == 19, Year %in% 1998:2006) %>% 
  filter(LifeStatus) %>% 
  filter(!(Family %in% c("muerto", "ND"))) %>% 
  ggplot(aes(XTreeUTM, YTreeUTM, col = as.character(Subplot))) +
  geom_point() +
  theme_bw() +
  coord_fixed() +
  facet_wrap(~ Year) +
  ggtitle("Missiones Plot 19") +
  theme(axis.title = element_blank(), axis.text = element_blank(), 
        axis.ticks = element_blank()) +
  scale_color_discrete("Subplot")
```

```{r missplot}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_tsv("outputs/missiones.tsv") %>% 
  group_by(site, year, rel_year, delta_ba, plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = plot)) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Basal area of tree " >=10 ~"cm dbh ["~m^{2}~ha^{-~1}~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))
```

## Moju

```{r mojuprep}
#| eval: false
moju <- read_csv("data/harmonized_datasets_ss/output_moju.csv", 
              locale = readr::locale(encoding = "latin1")) %>% 
  mutate(Site = 'Moju') %>% 
  filter(LifeStatus) %>% 
  select(Site, Year, Plot, PlotArea, VernName, Diameter) %>% 
  separate(VernName, c("VernName", "GenusSpecies"), sep = "\\[") %>% 
  select(-VernName) %>% 
  mutate(GenusSpecies = gsub("]", "", GenusSpecies)) %>% 
  separate(GenusSpecies, c("Genus", "Species")) %>% 
  mutate(Species = ifelse(Genus == "", 'undet', Species)) %>% 
  mutate(Genus = ifelse(Genus == "", 'undet', Genus)) %>% 
  mutate(diameter_class = ifelse(Diameter < 30, 10, 30)) %>% 
  mutate(diameter_class = ifelse(Diameter < 80, diameter_class, 80)) %>% 
  filter(!is.na(diameter_class)) %>% 
  group_by(Site, Year, Plot, PlotArea, Genus, Species, diameter_class) %>% 
  summarise(abundance = n()/unique(PlotArea),
            ba = sum((Diameter/2)^2*pi)/10^4/unique(PlotArea)) %>%
  rename_all(tolower) %>% 
  rename(area = plotarea) %>% 
  mutate(rel_year = year - 1997)
delta_ba <- moju %>% 
  group_by(plot, rel_year) %>% 
  summarise(ba = sum(ba)) %>% 
  filter(rel_year < 6) %>% 
  group_by(plot, post = as.numeric(rel_year > 0)) %>% 
  summarise(ba_mean = mean(ba), ba_min = min(ba)) %>% 
  gather(metric, value, -plot, -post) %>% 
  mutate(metric = paste0(metric, "_", post)) %>% 
  select(-post) %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  mutate(delta_ba = ba_mean_0 - ba_min_1) %>% 
  mutate(delta_ba = ifelse(delta_ba < 1, 0, delta_ba)) %>% 
  mutate(delta_ba_pct = delta_ba/ba_mean_0*100) %>% 
  rename(ba_pre = ba_mean_0, ba_post = ba_min_1) %>% 
  select(plot, ba_pre, ba_post, delta_ba, delta_ba_pct)
moju <- moju %>% 
  left_join(delta_ba) %>% 
  mutate_at(c("delta_ba", "delta_ba_pct"), ~ ifelse(is.na(.), 0, .))
write_tsv(moju, "outputs/moju.tsv")
```

```{r mojplot}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_tsv("outputs/moju.tsv") %>% 
  group_by(site, year, rel_year, delta_ba, plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = plot)) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Basal area of tree " >=10 ~"cm dbh ["~m^{2}~ha^{-~1}~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))
```

## All

```{r allprep}
#| eval: false
bind_rows(
  read_tsv("outputs/paracou.tsv"),
  read_tsv("outputs/missiones.tsv"),
  read_tsv("outputs/moju.tsv")
) %>% write_tsv("outputs/gathered.tsv")
```

```{r allplot}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_tsv("outputs/gathered.tsv") %>% 
  group_by(site, year, rel_year, delta_ba, plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = paste(site, plot))) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Basal area of tree " >=10 ~"cm dbh ["~m^{2}~ha^{-~1}~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))
```

```{r allplotrel}
#| message: false
#| warning: false
#| fig-cap: "Caption."
read_tsv("outputs/gathered.tsv") %>% 
  group_by(site, year, rel_year, delta_ba, ba_pre, plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba/ba_pre*100, 
             col = delta_ba/ba_pre*100, 
             group = paste(site, plot))) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Relative basal area of tree " >=10 ~"cm dbh ["~"%"~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))
```

## Logging

> Logging intensity: % basal area or volume lost (see metadata table)

**To discuss.** The available information might be very different depending on the site. The presence of pre-exploitation census will be a big difference to have an idea of pre and post harvest basal area, aboveground biomass, number of trees etc. Some sites may have only blur metadata. And some sites may have inventories of harvested trees with detailed information.

## Other plots infos

> Wherever available: liana infestation index, invasive species, etc. 

**To discuss.** I have currently no clue of what could be available.
